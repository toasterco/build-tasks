var deploy = function(sourceFolder, remoteURL, message) {



	// To run this script, just cd to its container directory and
	// node deploy.js
	// (and maybe do a `npm install` first, to satisfy dependencies)


	// Variables --------------------------------------------------------------------------------------

	// Node JS Requirements
	var fs = require('fs');
	var ArgumentParser = require('argparse').ArgumentParser;
	var exec = require('child_process').exec;
	var sys = require('sys');
	var path = require('path');
	var cleanCSS = require('clean-css');
	var charm = require('charm')();

	// Console Commands
	var ccBlinkSlow = '\x1b[5m';
	var ccBlack = '\x1b[30m';
	var ccRed = '\x1b[31m';
	var ccGreen = '\x1b[32m';
	var ccYellow = '\x1b[33m';
	var ccBlue = '\x1b[34m';
	var ccRed = '\x1b[35m';
	var ccCyan = '\x1b[36m';
	var ccWhite = '\x1b[37m';
	var ccReset = '\x1b[0m';
	var ccInvert = '\x1b[7m';
	var ccBold = '\x1b[1m';

	var loadingAnimation = [
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ___<", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                   o", "_____________ o __<(", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                   _", "                  o)", "_____________ o _<(_", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                   .", "                  __", "                 o)_", "_____________ o <(__", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                  .-", "                 __|", "                o)__", "_____________ o (__(", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                   (", "                 .--", "                __||", "               o)__ ", "_____________ o __(*", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                   (", "                  ()", "                .--.", "               __||_", "              ~)__ |", "_____________.o _(*)", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                  ( ", "                 (  ", "               .--. ", "              __||__", "             o)__ |_", "____________< o (*)_", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                  ( ", "                  ) ", "              .--.  ", "             __||___", "            o)__ |_ ", "___________<( o *)_(", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                   (", "                (   ", "               ()   ", "             .--.  -", "            __||___|", "           o)__ |_ |", "__________<(  o )_(*", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                  ( ", "                 ) )", "              (     ", "            .--.  --", "           __||___|[", "          o)__ |_ | ", "_________<(_  o _(*)", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                 ) )", "              ()    ", "           .--.  ---", "          __||___|[_", "         o)__ |_ | .", "________<(_ ( o (*)_", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                  ( ", "                (  )", "             ( ) )  ", "            ()      ", "          .--.  ----", "         __||___|[_]", "        o)__ |_ | ..", "_______<(__(* o *)_~", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                  ( ", "                   )", "             (   )  ", "            (       ", "         .--.  -----", "        __||___|[_]|", "       o)__ |_ | ..|", "______<(__(*) o )_~_", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "              (  )  ", "           ( )      ", "          (         ", "        .--.  ----- ", "       __||___|[_]| ", "      o)__ |_ | ..|=", "_____<(__(*)_ o _~__", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["               (    ", "                )  )", "            )       ", "         ()        _", "       .--.  ----- |", "      __||___|[_]| |", "     o)__ |_ | ..|=|", "____<(__(*)_( o ~___", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["               (    ", "             (  )   ", "          (   )     ", "          )       __", "      .--.  ----- | ", "     __||___|[_]| |.", "    o)__ |_ | ..|=|_", "___<(__(*)_(* o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["             (      ", "           (  )  )  ", "        ( ) )       ", "       ()        ___", "     .--.  ----- |  ", "    __||___|[_]| |.|", "   o)__ |_ | ..|=|_|", "__<(__(*)_(*) o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["             (      ", "                )   ", "        ( )         ", "       (        ____", "    .--.  ----- |  _", "   __||___|[_]| |.|#", "  o)__ |_ | ..|=|_|-", "_<(__(*)_(*)_ o ___~", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["           (        ", "         (  )  )    ", "      ( ) )         ", "     ()        ____.", "   .--.  ----- |  _ ", "  __||___|[_]| |.|#|", " o)__ |_ | ..|=|_|-|", "<(__(*)_(*)_~ o __~(", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "            )  )    ", "      () )          ", "     (        ____._", "  .--.  ----- |  _  ", " __||___|[_]| |.|#|.", "o)__ |_ | ..|=|_|-|_", "(__(*)_(*)_~_ o _~(*", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["         ( )        ", "       (  )         ", "      ) )           ", "   ()        ____.__", " .--.  ----- |  _  -", "__||___|[_]| |.|#|.[", ")__ |_ | ..|=|_|-|__", "__(*)_(*)_~__ o ~(*)", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["           )        ", "       (  )         ", "   (  ) )           ", "    )       ____.___", ".--.  ----- |  _  - ", "_||___|[_]| |.|#|.[]", "__ |_ | ..|=|_|-|___", "_(*)_(*)_~___ o (*)_", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["       (            ", "     (  )  )        ", "  ( ) )             ", " ()        ____.____", "--.  ----- |  _  - a", "||___|[_]| |.|#|.[].", "_ |_ | ..|=|_|-|____", "(*)_(*)_~____ o *)__", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["      ( )           ", "    (               ", " (  )               ", " )        ____._____", "-.  ----- |  _  - a:", "|___|[_]| |.|#|.[].[", " |_ | ..|=|_|-|_____", "*)_(*)_~____  o )___", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["     (              ", "   (  )  )          ", "( ) )               ", ")        ____.______", ".  ----- |  _  - a:f", "___|[_]| |.|#|.[].[]", "|_ | ..|=|_|-|______", ")_(*)_~_____~ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["     ( )            ", "   (  )             ", " ( )                ", "        ____.______.", "  ----- |  _  - a:f ", "__|[_]| |.|#|.[].[].", "_ | ..|=|_|-|_______", "_(*)_~_____~( o ___(", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", " (  )               ", ") )                 ", "       ____.______._", " ----- |  _  - a:f -", "_|[_]| |.|#|.[].[].[", " | ..|=|_|-|________", "(*)_~_____~(* o __(*", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["  (                 ", "(                   ", " )                  ", "      ____.______.__", "----- |  _  - a:f - ", "|[_]| |.|#|.[].[].[]", "| ..|=|_|-|_________", "*)_~_____~(*) o _(*)", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		[" (                  ", "                    ", ")                   ", "     ____.______.___", "---- |  _  - a:f -  ", "[_]| |.|#|.[].[].[].", " ..|=|_|-|__________", ")_~_____~(*)_ o (*)_", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		[" (                  ", " )                  ", "                    ", "    ____.______.____", "--- |  _  - a:f -   ", "_]| |.|#|.[].[].[]..", "..|=|_|-|___________", "_~_____~(*)__ o *)__", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", ")                   ", "                    ", "   ____.______._____", "-- |  _  - a:f -   |", "]| |.|#|.[].[].[]..|", ".|=|_|-|___________|", "~_____~(*)___ o )___", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "  ____.______._____ ", "- |  _  - a:f -   | ", "| |.|#|.[].[].[]..| ", "|=|_|-|___________| ", "_____~(*)____ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " |  _  - a:f -   |  ", " |.|#|.[].[].[]..|  ", "=|_|-|___________|  ", "____~(*)____( o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " |  _  - a:f -   |  ", " |.|#|.[].[].[]..|  ", "=|_|-|___________|  ", "____~(*)____( o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.: |.[].[].[]..|  ", "=|_: |___________|  ", "____-(*)____( o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.: |.[].[].[]..|  ", "=|_: |___________|  ", "____-(*)____( o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.:o|.[].[].[]..|  ", "=|_-||___________|  ", "____<(*)____( o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.: |.[].[].[]..|  ", "=|_:o|__________.|  ", "___/|\\,)____( o.____", "~ ~<< # ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.: |.[].[].[]..|  ", "=|_: |___________   ", "___ o *)____( o.'___", "~ ~/|\\, ~ ~ ~< >~ ~ ", "    | #       |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.:o|.[].[].[]..   ", "=|_: |_________ hi! ", "___ o *)____( o  ___", "~ ~/|\\, ~ ~ ~/|>~ ~ ", "    | #       |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.:o|.[].[].[].    ", "=|_: |_____ .   hi! ", "___ o *)___  \\o ____", "~ ~<< , ~ ~    >~ ~ ", "    | #       |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.:o|.[].[].[].    ", "=|_: |____  .  .hi! ", "___  o )____ \\o ____", "~ ~  \\, ~ ~    >~ ~ ", "    |\\#       |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.:o|.[].[].[].    ", "=|_/||____      hi! ", "___ < o , __ \\o ____", "~ ~   |~# ~ ~  >~ ~ ", "     />       |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.: |.[].[].[]..   ", "=|_:o|________  hi! ", "___ |  o ___( o ____", "~ ~<<  <, ~ ~  >~ ~ ", "       /#     |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " | ._  - a:f -   |  ", " |.: |.[].[].[]..   ", "=|_: |_________ -:. ", "___ o * o __( o ____", "~ ~<|\\  ,.~ ~< >~ ~ ", "    |   #\\    |     "],
		["                    ", "                    ", "                    ", " ____.______._____  ", " |  _  - a:f -   |  ", " |.|#|.[].[].[]..   ", "=|_|-|__________ .  ", "___ o *) o _( o ____", "~ ~<|>~ ,<  ~< >~ ~ ", "    |   #|    |     "],
		["                    ", "                    ", "                    ", "____.______._____   ", "|  _  - a:f -   |   ", "|.|#|.[].[].[]..|   ", "|_|-|___________.   ", "___ o )__ o *) o ___", "~ ~<|>~ ~ < ~ ~|. ~ ", "    |    /#   /|    "],
		["                    ", "                    ", "                    ", "___.______._____    ", "  _  - a:f -   |    ", ".|#|.[].[].[]..|    ", "_|-|___________|    ", "__~ o ___ (o __ o___", "~ ~<|>~ ~  <  ~ < ~ ", "    |      |#   |.  "],
		["                    ", "                    ", "                    ", "__.______._____     ", " _  - a:f -   |     ", "|#|.[].[].[]..|     ", "|-|___________|     ", "_~( o ___(* o __ o _", "~ ~<|>~ ~ ~ | ~  <. ", "    |       #\\   >. "],
		["                    ", "                    ", "                    ", "_.______._____      ", "_  - a:f -   |      ", "#|.[].[].[]..|      ", "-|___________|      ", "~(* o___(*)_ o __ o ", "~ ~<|>~ ~ ~ ,|~ ~ |\\", "    |       #>   /. "],
		["                    ", "                    ", "                    ", ".______._____       ", "  - a:f -   |       ", "|.[].[].[]..|       ", "|___________|       ", "(*) o _(*)___ o __ o", "~ ~<|>~ ~ ~ ~,| ~ .|", "    |        #>   .>"],
		["                    ", "                    ", "                    ", "______._____        ", " - a:f -   |        ", ".[].[].[]..|        ", "___________|        ", "*)_ o (*)_____ o ___", "~ ~< \\~ ~ ~ ~  <~   ", "    |\\        /#    "],
		["                    ", "                    ", "                    ", "_____._____         ", "- a:f -   |         ", "[].[].[]..|         ", "__________|         ", ")___ o )_______ o __", "~ ~ <<~ ~ ~ ~ ~ |.  ", "    /|         .|#  "],
		["                    ", "                    ", "                    ", "____._____          ", " a:f -   |          ", "].[].[]..|          ", "_________|          ", "____( o ________ o _", "~ ~ ~ |.~ ~ ~ ~  <  ", "     .|          #\\ "],
		["                    ", "                    ", "                    ", "___._____           ", "a:f -   |           ", ".[].[]..|           ", "________|           ", "___(*) o ________ o ", "~ ~ ~ < ~ ~ ~ ~ ~,| ", "       |\\        #> "],
		["                    ", "                    ", "                    ", "__._____            ", ":f -   |            ", "[].[]..|            ", "_______|  .         ", "__(*)__ o ________ o", "~ ~ ~  .|\\  ~ ~ ~  <", "       .>         #|"],
		["                    ", "                    ", "                    ", "_._____             ", "f -   |             ", "].[]..|     ,       ", "______|   .         ", "_(*)____ o _________", "~ ~ ~ ~  <  ~ ~ ~ ~ ", "        /|          "],
		["                    ", "                    ", "                    ", "._____              ", " -   |       .      ", ".[]..|       ?      ", "_____|     .        ", "(*)______ o ________", "~ ~ ~ ~ ~ | ~ ~ ~ ~ ", "         .>         "],
		["                    ", "                    ", "                    ", "_____         .     ", "-   |      - ? '    ", "[]..|       , `     ", "____|               ", "*)________ o _______", "~ ~ ~ ~ ~  |  ~ ~ ~ ", "           |\\       "],
		["                    ", "                    ", "             .      ", "____            .   ", "   |       ` ?      ", "]..|           '    ", "___|                ", ")__________ o ______", "~ ~ ~ ~ ~ ~ < ~ ~ ~ ", "           .|       "],
		["                    ", "           .        ", "                    ", "___      .       '  ", "  |          ?      ", "..|                 ", "__|                 ", "____________ o _____", "~ ~ ~ ~ ~ ~  |. ~ ~ ", "            /|      "],
		["                    ", "                    ", "                    ", "__                  ", " |           :      ", ".|                  ", "_|                  ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~ < ~ ~ ", "             .|     "],
		["                    ", "                    ", "                    ", "_                   ", "|            .      ", "|                   ", "|                   ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~ |>~ ~ ", "             /|     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~<|>~ ~ ", "             /|     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "],
		["                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "                    ", "_____________ o ____", "~ ~ ~ ~ ~ ~ ~< >~ ~ ", "              |     "]
	];
	var loadingSpinner = ['.', 'o', 'O', '@', '*'];
	var loadingFrame = 0;
	var animationInterval;


	// Functions --------------------------------------------------------------------------------------


	/**
	 * Help - will display a list of avalible commands & parameters
	 */

	function hadleError(error) {
		console.log('ERROR');
		//	execSync();
	}


	/**
	 *	Start Loading Animation
	 */

	function startLoadingAnimation(url, message) {
		charm.pipe(process.stdout);
		charm.reset();
		animationInterval = setInterval(function() {
			renderAnimation(url, message, true)
		}, 150);
	}

	/**
	 * Render Animation
	 */

	function renderAnimation(url, message, deploying) {
		charm.write(ccInvert);
		if (loadingFrame == loadingAnimation.length) loadingFrame = 0;
		charm.position(0, 1);
		var frame = loadingAnimation[loadingFrame];
		for (var i = 0; i < frame.length; i++) {
			charm.position(0, i + 1);
			charm.write(frame[i]);
		}
		loadingFrame++;

		charm.position(0, i + 2);
		charm.write(ccReset);
		charm.write(message);

		charm.position(0, i + 3);
		if (deploying) {
			charm.write('Deploying ' + loadingSpinner[loadingFrame % loadingSpinner.length]);
			charm.position(0, i + 4);
			charm.write('to ' + url + ' ');
		}
	}

	
	/**
	 * Stop Loading Animation
	 */

	function stopLoadingAnimation() {
		clearInterval(animationInterval);
	}


	/**
	 * Deploy
	 */

	function deploy(dir, url, message) {
		debugger;
		exec('appcfg.py --oauth2 update ' + dir, {}, function(error, stdout, stderr) {
			stopLoadingAnimation();
			renderAnimation('', 'Deployment Complete', false);
			console.log('');
			console.log(stdout);
			console.log(stderr);
		});
		startLoadingAnimation(url, message);
	}

	deploy(sourceFolder, remoteURL, message);
};

exports.deploy = deploy;
